## 1. 概述

这些年来，我们使用的系统的性能呈指数级增长。因此，Java VM 支持的线程数也增加了。

但是，我们实际上能够创造多少？ 答案不是一个确切的数字，因为它取决于许多因素。

我们将讨论其中的几个因素，以及它们如何影响我们可以在 Java VM 中创建的线程数。

## 2.堆栈内存

线程最重要的组件之一是它的堆栈。我们创建的最大堆栈大小和线程数与可用的系统内存量直接相关。

因此，增加内存容量也会增加我们可以在系统上运行的最大线程数。有关堆栈大小的更多详细信息，请参阅我们的文章[在 JVM 中配置堆栈大小](https://www.baeldung.com/jvm-configure-stack-sizes)。

最后，值得一提的是，从 Java 11 开始，JVM 不会主动为堆栈提交所有保留内存。这有助于增加我们可以运行的线程数。换句话说，即使我们增加最大堆栈大小，线程使用的内存量也将基于实际堆栈大小。

## 3.堆内存

堆不直接影响我们可以执行的线程数。但是，它也使用相同的系统内存。

因此，增加堆大小会限制堆栈的可用内存，从而减少我们可以创建的最大线程数。

## 4. 操作系统的选择

当创建一个新的 Java 线程时，一个新的本机操作系统线程被创建并直接链接到来自 VM 的线程。

因此，操作系统控制着线程的管理。

此外，可以根据操作系统的类型应用各种限制。

在以下小节中，我们将介绍最常见系统的这些方面。

### 4.1. Linux

基于 Linux 的系统在[内核](https://www.baeldung.com/cs/os-kernel)级别将线程视为进程。因此，像pid_max内核参数这样的进程限制将直接影响我们可以创建的线程数。

另一个内核参数是threads-max，它描述了线程的总体最大数量。

我们可以通过执行sysctl kernel.<parameter-name>来检索所有这些参数。

最后，还有每个用户的最大进程限制，可使用ulimit -u命令检索。

### 4.2. 视窗

在 Windows 机器上，没有为线程指定限制。因此，我们可以根据需要创建任意数量的线程，直到我们的系统用完可用的系统内存。

### 4.3. 苹果系统

运行 macOS 的系统有两个主要限制，由两个内核参数定义：

-   num_threads 表示总体上可以创建的最大线程数
-   num_taskthreads 表示每个进程的最大线程数

这些参数的值可以通过执行sysctl kern 来访问。<参数名称>。

值得一提的是，当达到其中一个限制时，将抛出OutOfMemoryError ，这可能会产生误导。

## 5.虚拟线程

[我们可以通过利用Project Loom 附带的轻量级虚拟线程来](https://www.baeldung.com/java-virtual-thread-vs-thread)进一步增加我们可以创建的线程数量，该虚拟线程尚未公开。

虚拟线程由 JVM 创建，不使用操作系统线程，这意味着我们可以同时创建数百万个。

## 六，总结

在本文中，我们研究了可能影响 Java 虚拟机中可创建的最大线程数的最重要方面。

但是，在大多数情况下，增加限制不太可能永久解决可伸缩性问题。我们需要考虑重新考虑应用程序的实现，甚至应用水平扩展。